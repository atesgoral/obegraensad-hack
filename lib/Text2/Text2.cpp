#include <string.h>

#include "Text2.h"

#define W 4
#define H 6

// clang-format off
const unsigned char FONT_454[] = {
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x30, 0x30, 0x20, 0x00, 0x30, 0x00,
  0xcc, 0x88, 0x00, 0x00, 0x00, 0x00,
  0x88, 0xfc, 0x88, 0xfc, 0x88, 0x00,
  0x20, 0xb8, 0xf0, 0x3c, 0xb8, 0x00,
  0xcc, 0x08, 0x30, 0x80, 0xcc, 0x00,
  0xb0, 0xcc, 0x34, 0xcc, 0xbc, 0x00,
  0x30, 0x20, 0x00, 0x00, 0x00, 0x00,
  0x70, 0x80, 0xc0, 0x80, 0x70, 0x00,
  0x34, 0x08, 0x0c, 0x08, 0x34, 0x00,
  0x00, 0x98, 0x74, 0x98, 0x00, 0x00,
  0x00, 0x30, 0xfc, 0x30, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x30, 0x80, 0x00,
  0x00, 0x00, 0xfc, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x30, 0x00,
  0x0c, 0x18, 0x30, 0x90, 0xc0, 0x00,
  0x78, 0xcc, 0xcc, 0xcc, 0xb4, 0x00,
  0x30, 0xb0, 0x30, 0x30, 0x30, 0x00,
  0xe4, 0x0c, 0x74, 0x80, 0xfc, 0x00,
  0xb8, 0x0c, 0x34, 0x0c, 0xb8, 0x00,
  0x30, 0x90, 0xcc, 0xfc, 0x0c, 0x00,
  0xfc, 0xc0, 0xf8, 0x0c, 0xf8, 0x00,
  0x78, 0xc0, 0xb8, 0xcc, 0xb8, 0x00,
  0xfc, 0x08, 0x30, 0x80, 0xc0, 0x00,
  0xb8, 0xcc, 0x74, 0xcc, 0xb8, 0x00,
  0xb8, 0xcc, 0xbc, 0x0c, 0xb4, 0x00,
  0x00, 0x30, 0x00, 0x30, 0x00, 0x00,
  0x00, 0x30, 0x00, 0x30, 0x80, 0x00,
  0x0c, 0x30, 0xc0, 0x30, 0x0c, 0x00,
  0x00, 0xfc, 0x00, 0xfc, 0x00, 0x00,
  0xc0, 0x30, 0x0c, 0x30, 0xc0, 0x00,
  0xb4, 0x0c, 0x34, 0x00, 0x30, 0x00,
  0x78, 0x8c, 0xcc, 0x80, 0x6c, 0x00,
  0x74, 0x88, 0xcc, 0xec, 0xcc, 0x00,
  0xf4, 0xcc, 0xf4, 0xcc, 0xf4, 0x00,
  0x7c, 0x80, 0xc0, 0x80, 0x7c, 0x00,
  0xe4, 0xc8, 0xcc, 0xc8, 0xe4, 0x00,
  0xfc, 0xc0, 0xf0, 0xc0, 0xfc, 0x00,
  0xfc, 0xc0, 0xf0, 0xc0, 0xc0, 0x00,
  0x7c, 0x80, 0xc0, 0x8c, 0x7c, 0x00,
  0xcc, 0xcc, 0xfc, 0xcc, 0xcc, 0x00,
  0x30, 0x30, 0x30, 0x30, 0x30, 0x00,
  0x0c, 0x0c, 0x0c, 0xcc, 0xb8, 0x00,
  0xcc, 0xc8, 0xe0, 0xc8, 0xcc, 0x00,
  0xc0, 0xc0, 0xc0, 0xc0, 0xfc, 0x00,
  0x88, 0xec, 0xfc, 0xdc, 0xcc, 0x00,
  0x8c, 0xdc, 0xec, 0xdc, 0xc8, 0x00,
  0x74, 0x88, 0xcc, 0x88, 0x74, 0x00,
  0xe4, 0xcc, 0xcc, 0xe4, 0xc0, 0x00,
  0x74, 0x88, 0xcc, 0x8c, 0x7c, 0x00,
  0xe4, 0xcc, 0xcc, 0xe4, 0xcc, 0x00,
  0xb8, 0xc0, 0xb8, 0x0c, 0xb8, 0x00,
  0xfc, 0x30, 0x30, 0x30, 0x30, 0x00,
  0xcc, 0xcc, 0xcc, 0x8c, 0x68, 0x00,
  0xcc, 0xcc, 0xcc, 0x98, 0x30, 0x00,
  0xcc, 0xcc, 0xdc, 0xfc, 0xec, 0x00,
  0xcc, 0x88, 0x20, 0x88, 0xcc, 0x00,
  0xcc, 0x88, 0x64, 0x30, 0x30, 0x00,
  0xfc, 0x08, 0x30, 0x80, 0xfc, 0x00,
  0xf0, 0xc0, 0xc0, 0xc0, 0xf0, 0x00,
  0xc0, 0x90, 0x30, 0x18, 0x0c, 0x00,
  0x3c, 0x0c, 0x0c, 0x0c, 0x3c, 0x00,
  0x30, 0xdc, 0x88, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0xfc,
  0xc0, 0x20, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x6c, 0x8c, 0x8c, 0x6c, 0x00,
  0xc0, 0xe4, 0xc8, 0xc8, 0xe4, 0x00,
  0x00, 0x6c, 0x80, 0x80, 0x6c, 0x00,
  0x0c, 0x6c, 0x8c, 0x8c, 0x6c, 0x00,
  0x00, 0x38, 0x8c, 0xe0, 0x7c, 0x00,
  0x1c, 0x30, 0xb8, 0x30, 0x30, 0x30,
  0x00, 0xe4, 0x88, 0x6c, 0x08, 0xe4,
  0xc0, 0xe4, 0xc8, 0xcc, 0xcc, 0x00,
  0x30, 0x00, 0x70, 0x30, 0x2c, 0x00,
  0x0c, 0x00, 0x1c, 0x0c, 0xcc, 0xb8,
  0xc0, 0xcc, 0xe0, 0xc8, 0xcc, 0x00,
  0x70, 0x30, 0x30, 0x20, 0x18, 0x00,
  0x00, 0xf4, 0xfc, 0xec, 0xcc, 0x00,
  0x00, 0xe4, 0xc8, 0xcc, 0xcc, 0x00,
  0x00, 0x74, 0x88, 0x88, 0x74, 0x00,
  0x00, 0xe4, 0xc8, 0xc8, 0xe4, 0xc0,
  0x00, 0x64, 0x88, 0x8c, 0x6c, 0x0c,
  0x00, 0x8c, 0xe0, 0xc0, 0xc0, 0x00,
  0x00, 0x6c, 0x90, 0x18, 0xf4, 0x00,
  0x30, 0xb8, 0x30, 0x20, 0x18, 0x00,
  0x00, 0xcc, 0xcc, 0x8c, 0x78, 0x00,
  0x00, 0xcc, 0xcc, 0x98, 0x20, 0x00,
  0x00, 0xcc, 0xdc, 0xfc, 0xec, 0x00,
  0x00, 0xcc, 0x64, 0x64, 0xcc, 0x00,
  0x00, 0xcc, 0xcc, 0x78, 0x08, 0xa4,
  0x00, 0xfc, 0x18, 0x90, 0xfc, 0x00,
  0x2c, 0x30, 0xd0, 0x30, 0x2c, 0x00,
  0x30, 0x30, 0x30, 0x30, 0x30, 0x30,
  0xe0, 0x30, 0x1c, 0x30, 0xe0, 0x00,
  0xb0, 0xc0, 0x74, 0x0c, 0x38, 0x00,
  0xec, 0x88, 0x88, 0x88, 0xec, 0x00,
};
// clang-format on

int Text2::renderChar(char pixels[PIXELS], char c, int x, int y) {
  int offset = c * 6;
  int Y;
  int X;

  for (int row = 0; row < H; row++, offset++) {
    Y = row + y;

    if (Y < 0 || Y >= ROWS) {
      continue;
    }

    unsigned char bitmask = 0xc0;
    int bitshift = 6;

    for (int col = 0; col < W; col++, bitmask >>= 2, bitshift -= 2) {
      X = col + x;

      if (X < 0 || X >= COLS) {
        continue;
      }

      pixels[AT(X, Y)] = (FONT_454[offset] & bitmask) >> bitshift;
    }
  }

  return W;
}

void Text2::renderText(char pixels[PIXELS], const char *text, int x, int y,
                       int kerning) {
  int o = 0;
  int len = strlen(text);

  for (int i = 0; i < len; i++) {
    o += renderChar(pixels, text[i], x + o, y) + kerning;
  }
}

void Text2::renderText(char pixels[PIXELS], const char *text, int x, int y) {
  renderText(pixels, text, x, y, 1);
}
